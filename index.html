<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Wedding of Erika & Agus</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Dynamically loaded via JS) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style id="dynamic-styles">
        /* Default styles, will be overridden by data from Firestore */
        :root {
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Poppins', sans-serif;
            --color-bg: #f8f4e9; /* Light Beige */
            --color-text: #3d3d3d; /* Dark Brown */
            --color-accent: #d4af37; /* Gold */
            --color-card-bg: rgba(255, 255, 255, 0.7);
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-body);
            background-color: var(--color-bg);
            color: var(--color-text);
            opacity: 0;
            transition: opacity 1s ease-in-out;
            padding-bottom: 80px;
        }
        h1, h2, h3, .font-heading {
            font-family: var(--font-heading);
        }
        .accent-text { color: var(--color-accent); }
        .accent-bg { background-color: var(--color-accent); }
        .card { background-color: var(--color-card-bg); }
        .nav-active i, .nav-active span { color: var(--color-accent) !important; font-weight: 600; }
        .bottom-nav a { transition: color 0.3s; }
        .bottom-nav a:hover { color: var(--color-accent); }

        /* Animation Classes */
        .reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s, transform 0.8s;
            transition-timing-function: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .reveal.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Lightbox */
        #lightbox { display: none; background-color: rgba(0,0,0,0.9); }
        #lightbox-img { animation: zoomInModal 0.5s; }
        @keyframes zoomInModal { from {transform: scale(0.8)} to {transform: scale(1)} }
    </style>
</head>
<body class="antialiased">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-cover bg-center transition-opacity duration-1000">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="relative z-10 text-center text-white p-4">
            <p class="text-lg tracking-widest">The Wedding Of</p>
            <h1 id="splash-groom-name" class="font-heading text-4xl md:text-6xl my-4">Mempelai Pria</h1>
            <h1 id="splash-bride-name" class="font-heading text-4xl md:text-6xl">& Mempelai Wanita</h1>
            <p id="splash-date" class="mt-4 text-lg">Tanggal Pernikahan</p>
            <button id="open-invitation" class="mt-8 px-8 py-3 bg-white text-black font-bold rounded-full shadow-lg hover:scale-105 transition-transform">
                <i class="fas fa-envelope-open mr-2"></i> Buka Undangan
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="hidden">
        
        <!-- Hero Section -->
        <section id="hero" class="h-screen flex flex-col items-center justify-center text-center p-4 bg-cover bg-center bg-fixed relative">
             <div class="absolute inset-0 bg-black bg-opacity-50"></div>
            <div id="hero-content" class="relative z-10 text-white">
                <h2 class="text-xl">The Wedding Of</h2>
                <h1 id="hero-names" class="text-5xl md:text-7xl font-heading my-4">Erika & Agus</h1>
                <p id="hero-date" class="text-xl">20.07.2025</p>
            </div>
        </section>
        
        <!-- Couple Section -->
        <section id="couple" class="py-20 px-4 text-center">
            <div class="container mx-auto max-w-4xl">
                <div class="reveal">
                    <i class="fas fa-heart accent-text text-4xl mb-4"></i>
                    <h2 class="text-4xl font-heading mb-4">Pasangan Mempelai</h2>
                    <p class="max-w-2xl mx-auto mb-12">Dengan memohon rahmat dan ridho Allah SWT, kami bermaksud menyelenggarakan pernikahan putra-putri kami:</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
                    <!-- Groom -->
                    <div class="reveal">
                        <img id="groom-photo" src="https://placehold.co/300x300/e2e8f0/e2e8f0?text=Pria" alt="Mempelai Pria" class="w-48 h-48 rounded-full mx-auto mb-4 object-cover shadow-lg">
                        <h3 id="groom-name" class="text-3xl font-heading accent-text">Nama Mempelai Pria</h3>
                        <p id="groom-parents" class="mt-2">Putra dari Bpk. Ayah & Ibu Ibu</p>
                    </div>
                     <!-- Bride -->
                    <div class="reveal">
                        <img id="bride-photo" src="https://placehold.co/300x300/e2e8f0/e2e8f0?text=Wanita" alt="Mempelai Wanita" class="w-48 h-48 rounded-full mx-auto mb-4 object-cover shadow-lg">
                        <h3 id="bride-name" class="text-3xl font-heading accent-text">Nama Mempelai Wanita</h3>
                        <p id="bride-parents" class="mt-2">Putri dari Bpk. Ayah & Ibu Ibu</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Event Section -->
        <section id="event" class="py-20 px-4 bg-opacity-50" style="background-color: rgba(0,0,0,0.02);">
            <div class="container mx-auto max-w-4xl text-center">
                <div class="reveal">
                    <i class="fas fa-calendar-check accent-text text-4xl mb-4"></i>
                    <h2 class="text-4xl font-heading mb-12">Waktu & Tempat</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Akad Nikah -->
                    <div class="card p-8 rounded-lg shadow-lg reveal">
                        <h3 class="text-3xl font-heading mb-4">Akad Nikah</h3>
                        <div class="space-y-3 text-left">
                            <p><i class="fas fa-calendar-alt w-6 accent-text"></i> <span id="akad-date"></span></p>
                            <p><i class="fas fa-clock w-6 accent-text"></i> <span id="akad-time"></span></p>
                            <p><i class="fas fa-map-marker-alt w-6 accent-text"></i> <span id="akad-location"></span></p>
                        </div>
                    </div>
                     <!-- Resepsi -->
                    <div class="card p-8 rounded-lg shadow-lg reveal">
                        <h3 class="text-3xl font-heading mb-4">Resepsi</h3>
                        <div class="space-y-3 text-left">
                           <p><i class="fas fa-calendar-alt w-6 accent-text"></i> <span id="resepsi-date"></span></p>
                           <p><i class="fas fa-clock w-6 accent-text"></i> <span id="resepsi-time"></span></p>
                           <p><i class="fas fa-map-marker-alt w-6 accent-text"></i> <span id="resepsi-location"></span></p>
                        </div>
                    </div>
                </div>
                <!-- Countdown -->
                <div class="card mt-12 p-6 rounded-lg shadow-lg reveal">
                    <div id="countdown" class="flex justify-center space-x-4 md:space-x-8 text-center">
                        <div><div class="text-4xl font-bold" id="days">00</div><div class="text-sm">Hari</div></div>
                        <div><div class="text-4xl font-bold" id="hours">00</div><div class="text-sm">Jam</div></div>
                        <div><div class="text-4xl font-bold" id="minutes">00</div><div class="text-sm">Menit</div></div>
                        <div><div class="text-4xl font-bold" id="seconds">00</div><div class="text-sm">Detik</div></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Gallery Section -->
        <section id="gallery" class="py-20 px-4">
             <div class="container mx-auto max-w-6xl text-center">
                <div class="reveal">
                    <i class="fas fa-images accent-text text-4xl mb-4"></i>
                    <h2 class="text-4xl font-heading mb-12">Momen Bahagia</h2>
                </div>
                <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Gallery images will be inserted here by JS -->
                </div>
            </div>
        </section>

        <!-- Location Section -->
        <section id="location" class="py-20 px-4 bg-opacity-50" style="background-color: rgba(0,0,0,0.02);">
            <div class="container mx-auto max-w-4xl text-center">
                 <div class="reveal">
                    <i class="fas fa-map-marked-alt accent-text text-4xl mb-4"></i>
                    <h2 class="text-4xl font-heading mb-12">Peta Lokasi</h2>
                </div>
                <div class="card p-4 rounded-lg shadow-lg reveal">
                    <iframe id="google-map" src="https://www.google.com/maps/embed?pb=" width="100%" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                </div>
            </div>
        </section>

        <!-- Guestbook Section -->
        <section id="guestbook" class="py-20 px-4">
            <div class="container mx-auto max-w-2xl text-center">
                 <div class="reveal">
                    <i class="fas fa-book-open accent-text text-4xl mb-4"></i>
                    <h2 class="text-4xl font-heading mb-12">Buku Tamu & Ucapan</h2>
                </div>
                <!-- Form -->
                <div class="card p-8 rounded-lg shadow-lg text-left mb-12 reveal">
                    <form id="guestbook-form">
                        <div class="mb-4"><label for="guestName" class="block mb-1">Nama</label><input type="text" id="guestName" class="w-full p-2 border rounded" required></div>
                        <div class="mb-4"><label for="guestAddress" class="block mb-1">Alamat</label><input type="text" id="guestAddress" class="w-full p-2 border rounded"></div>
                        <div class="mb-4"><label for="guestMessage" class="block mb-1">Ucapan</label><textarea id="guestMessage" rows="4" class="w-full p-2 border rounded" required></textarea></div>
                        <div class="mb-4"><label class="block mb-1">Konfirmasi Kehadiran</label><select id="guestRsvp" class="w-full p-2 border rounded"><option value="Hadir">Hadir</option><option value="Tidak Hadir">Tidak Hadir</option></select></div>
                        <button type="submit" id="submit-guestbook" class="w-full accent-bg text-white font-bold py-3 rounded hover:opacity-90 transition-opacity">Kirim Ucapan</button>
                    </form>
                </div>
                <!-- Wishes -->
                <div id="wishes-container" class="space-y-4 max-h-96 overflow-y-auto p-4 bg-white/50 rounded-lg">
                   <!-- Wishes will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="py-12 text-center text-sm">
            <p>Terima kasih atas doa restu Anda.</p>
            <p id="footer-names" class="font-heading text-2xl mt-2">Erika & Agus</p>
            <p class="mt-4 text-xs opacity-70">&copy; 2025. Five <i class="fa fa-smile"></i>.</p>
        </footer>

    </main>
    
    <!-- Music Player -->
    <div id="music-player" class="fixed bottom-24 right-4 z-40 hidden">
        <button id="music-toggle" class="w-12 h-12 rounded-full accent-bg text-white flex items-center justify-center shadow-lg">
            <i id="music-icon" class="fas fa-play"></i>
        </button>
        <audio id="background-music" loop></audio>
    </div>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 h-20 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.1)] flex justify-around items-center z-40 hidden">
        <a href="#couple" class="nav-item text-center text-gray-500"><i class="fas fa-heart text-2xl"></i><span class="block text-xs mt-1">Pasangan</span></a>
        <a href="#event" class="nav-item text-center text-gray-500"><i class="fas fa-calendar-alt text-2xl"></i><span class="block text-xs mt-1">Acara</span></a>
        <a href="#gallery" class="nav-item text-center text-gray-500"><i class="fas fa-images text-2xl"></i><span class="block text-xs mt-1">Galeri</span></a>
        <a href="#guestbook" class="nav-item text-center text-gray-500"><i class="fas fa-book-open text-2xl"></i><span class="block text-xs mt-1">Buku Tamu</span></a>
    </nav>
    
    <!-- Gallery Lightbox -->
    <div id="lightbox" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center p-4">
        <img id="lightbox-img" src="" alt="Galeri Foto" class="max-w-full max-h-full">
        <button id="lightbox-close" class="absolute top-4 right-4 text-white text-3xl">&times;</button>
    </div>


    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-wedding-app';
        let firebaseConfig = null;
        try { firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null; }
        catch (e) { console.error("Firebase config error:", e); }
        
        let db, auth;
        let animationEnabled = true;
        let countdownInterval;

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                (async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    loadInvitationData();
                    listenToGuestbook();
                })();
            } catch (error) { 
                console.error("Firebase init failed:", error); 
                document.body.style.opacity = '1';
            }
        } else {
            console.warn("Firebase config not found. Using default content.");
            updateContent({}); // Load with default content
            document.body.style.opacity = '1';
        }

        const configDocRef = db ? doc(db, `artifacts/${appId}/public/data/invitation/config`) : null;
        const guestbookColRef = db ? collection(db, `artifacts/${appId}/public/data/guestbook`) : null;

        // --- DYNAMIC CONTENT & STYLE LOADER ---
        function loadInvitationData() {
            if (!configDocRef) return;
            onSnapshot(configDocRef, (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : {};
                updateContent(data);
            }, (error) => {
                console.error("Error listening to config:", error);
                updateContent({}); // Load with defaults on error
            });
        }
        
        function updateStyles(displayConfig) {
            const styleEl = document.getElementById('dynamic-styles');
            const fontLink = document.createElement('link');
            fontLink.id = 'dynamic-font-link';
            const existingFontLink = document.getElementById('dynamic-font-link');
            if(existingFontLink) existingFontLink.remove();

            fontLink.href = `https://fonts.googleapis.com/css2?family=${displayConfig.headingFont.replace(' ', '+')}:wght@700&family=${displayConfig.bodyFont.replace(' ', '+')}&display=swap`;
            fontLink.rel = 'stylesheet';
            document.head.appendChild(fontLink);
            
            styleEl.innerHTML = `
                :root {
                    --font-heading: '${displayConfig.headingFont}', serif;
                    --font-body: '${displayConfig.bodyFont}', sans-serif;
                    --color-bg: ${displayConfig.backgroundColor};
                    --color-text: ${displayConfig.textColor};
                    --color-accent: ${displayConfig.accentColor};
                    --color-card-bg: ${getCardBgColor(displayConfig.backgroundColor)};
                }
                html { scroll-behavior: smooth; }
                body { font-family: var(--font-body); background-color: var(--color-bg); color: var(--color-text); opacity: 0; transition: opacity 1s ease-in-out; padding-bottom: 80px; }
                h1, h2, h3, .font-heading { font-family: var(--font-heading); }
                .accent-text { color: var(--color-accent); }
                .accent-bg { background-color: var(--color-accent); }
                .card { background-color: var(--color-card-bg); }
                .nav-active i, .nav-active span { color: var(--color-accent) !important; font-weight: 600; }
                .bottom-nav a { transition: color 0.3s; }
                .bottom-nav a:hover { color: var(--color-accent); }
                .reveal { opacity: 0; transform: translateY(30px); transition: opacity 0.8s, transform 0.8s; transition-timing-function: cubic-bezier(0.175, 0.885, 0.32, 1.275); }
                .reveal.visible { opacity: 1; transform: translateY(0); }
                 #lightbox { display: none; background-color: rgba(0,0,0,0.9); }
                 #lightbox-img { animation: zoomInModal 0.5s; }
                 @keyframes zoomInModal { from {transform: scale(0.8)} to {transform: scale(1)} }
            `;
            animationEnabled = displayConfig.animationEnabled === 'true';
            document.body.style.opacity = '1';
        }

        function updateContent(data) {
            const defaults = {
                groom: { name: 'Mempelai Pria', parents: 'Orang Tua', photoUrl: 'https://placehold.co/300x300/e2e8f0/e2e8f0?text=Pria' },
                bride: { name: 'Mempelai Wanita', parents: 'Orang Tua', photoUrl: 'https://placehold.co/300x300/e2e8f0/e2e8f0?text=Wanita' },
                akad: { date: 'Segera Dikonfirmasi', time: 'TBA', location: 'TBA' },
                resepsi: { date: 'Segera Dikonfirmasi', time: 'TBA', location: 'TBA' },
                display: { backgroundUrl: 'https://images.unsplash.com/photo-1525502613928-8822292049e6?q=80&w=1887&auto=format&fit=crop', musicUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3', accentColor: '#d4af37', backgroundColor: '#f8f4e9', textColor: '#3d3d3d', headingFont: 'Playfair Display', bodyFont: 'Poppins', animationEnabled: 'true' },
                gallery: []
            };
            const config = {
                ...defaults, ...data,
                groom: { ...defaults.groom, ...data.groom },
                bride: { ...defaults.bride, ...data.bride },
                akad: { ...defaults.akad, ...data.akad },
                resepsi: { ...defaults.resepsi, ...data.resepsi },
                display: { ...defaults.display, ...data.display },
            };
            
            updateStyles(config.display);

            const groomName = config.groom.name;
            const brideName = config.bride.name;
            document.getElementById('splash-groom-name').innerText = groomName.split(',')[0];
            document.getElementById('splash-bride-name').innerText = `& ${brideName.split(',')[0]}`;
            document.getElementById('splash-date').innerText = config.akad.date;
            document.getElementById('hero-names').innerText = `${groomName.split(',')[0]} & ${brideName.split(',')[0]}`;
            document.getElementById('hero-date').innerText = config.akad.date.replace(/,/g, '');
            document.getElementById('footer-names').innerText = `${groomName.split(',')[0]} & ${brideName.split(',')[0]}`;

            document.getElementById('groom-photo').src = config.groom.photoUrl;
            document.getElementById('groom-name').innerText = groomName;
            document.getElementById('groom-parents').innerText = `Putra dari ${config.groom.parents}`;
            
            document.getElementById('bride-photo').src = config.bride.photoUrl;
            document.getElementById('bride-name').innerText = brideName;
            document.getElementById('bride-parents').innerText = `Putri dari ${config.bride.parents}`;

            document.getElementById('akad-date').innerText = config.akad.date;
            document.getElementById('akad-time').innerText = config.akad.time;
            document.getElementById('akad-location').innerText = config.akad.location;
            document.getElementById('resepsi-date').innerText = config.resepsi.date;
            document.getElementById('resepsi-time').innerText = config.resepsi.time;
            document.getElementById('resepsi-location').innerText = config.resepsi.location;

            document.getElementById('hero').style.backgroundImage = `url('${config.display.backgroundUrl}')`;
            document.getElementById('splash-screen').style.backgroundImage = `url('${config.display.backgroundUrl}')`;

            const mapLocation = encodeURIComponent(config.akad.location);
            document.getElementById('google-map').src = `https://www.google.com/maps/embed/v1/place?key=YOUR_API_KEY_IS_NOT_NEEDED_HERE&q=${mapLocation}`;

            const audio = document.getElementById('background-music');
            if (audio.src !== config.display.musicUrl) {
                audio.src = config.display.musicUrl;
            }

            const galleryGrid = document.getElementById('gallery-grid');
            galleryGrid.innerHTML = '';
            (config.gallery || []).forEach(url => {
                const imgContainer = document.createElement('div');
                if(animationEnabled) imgContainer.className = 'reveal';
                imgContainer.innerHTML = `<img src="${url}" alt="Foto Galeri" class="w-full h-full object-cover rounded-lg shadow-md cursor-pointer hover:scale-105 transition-transform duration-300">`;
                galleryGrid.appendChild(imgContainer);
            });
            setupLightbox();
            startCountdown(config.akad.date);
        }
        
        function getCardBgColor(bgColor) {
            const rgb = parseInt(bgColor.substring(1), 16);   
            const r = (rgb >> 16) & 0xff;
            const g = (rgb >>  8) & 0xff;
            const b = (rgb >>  0) & 0xff;
            const luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
            return luma > 128 ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.1)';
        }


        // --- UI & Interaction LOGIC ---
        const splashScreen = document.getElementById('splash-screen');
        const mainContent = document.getElementById('main-content');
        const bottomNav = document.getElementById('bottom-nav');
        const musicPlayer = document.getElementById('music-player');
        
        document.getElementById('open-invitation').addEventListener('click', () => {
            splashScreen.style.opacity = '0';
            setTimeout(() => {
                splashScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                musicPlayer.classList.remove('hidden');
                document.body.style.overflow = 'auto';
                setupIntersectionObserver();
                document.getElementById('music-toggle').click();
            }, 1000);
        });

        function startCountdown(dateString) {
             if (!dateString || countdownInterval) return;
            const targetDate = new Date(`${dateString.split(', ')[1]} 09:00:00`).getTime();
            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate - now;
                document.getElementById('days').innerText = Math.max(0, Math.floor(distance / (1000 * 60 * 60 * 24))).toString().padStart(2, '0');
                document.getElementById('hours').innerText = Math.max(0, Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).toString().padStart(2, '0');
                document.getElementById('minutes').innerText = Math.max(0, Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))).toString().padStart(2, '0');
                document.getElementById('seconds').innerText = Math.max(0, Math.floor((distance % (1000 * 60)) / 1000)).toString().padStart(2, '0');
                if (distance < 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
        }

        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
            });
        });

        const guestbookForm = document.getElementById('guestbook-form');
        const submitBtn = document.getElementById('submit-guestbook');
        let existingGuests = new Set();

        function listenToGuestbook() {
            if (!guestbookColRef) return;
            const q = query(guestbookColRef, orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const wishesContainer = document.getElementById('wishes-container');
                wishesContainer.innerHTML = '';
                existingGuests.clear();
                
                const docs = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                const hadirDocs = docs.filter(d => d.rsvp === 'Hadir').reverse();

                docs.forEach(data => {
                    existingGuests.add(data.name.trim().toLowerCase());
                    let noHadirHtml = '';
                    if (data.rsvp === 'Hadir') {
                        const number = hadirDocs.findIndex(hd => hd.id === data.id) + 1;
                        noHadirHtml = `<span class="accent-bg text-white text-xs font-bold px-2 py-1 rounded-full ml-2">${number}</span>`;
                    }
                    const wishEl = document.createElement('div');
                    wishEl.className = "card text-left p-4 rounded-lg shadow";
                    wishEl.innerHTML = `
                        <div class="flex justify-between items-start">
                           <div>
                               <p class="font-bold">${data.name} ${noHadirHtml}</p>
                               <p class="text-xs opacity-70">${data.address || ''}</p>
                           </div>
                           <p class="text-xs opacity-60">${data.timestamp.toDate().toLocaleDateString('id-ID')}</p>
                        </div>
                        <p class="mt-2 text-sm">${data.message}</p>`;
                    wishesContainer.appendChild(wishEl);
                });
            }, (error) => {
                console.error("Error listening to guestbook: ", error);
            });
        }
        
        guestbookForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('guestName').value;
            const address = document.getElementById('guestAddress').value;
            const message = document.getElementById('guestMessage').value;
            const rsvp = document.getElementById('guestRsvp').value;

            if (existingGuests.has(name.trim().toLowerCase())) {
                alert('Anda sudah mengirimkan ucapan sebelumnya.');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerText = 'Mengirim...';
            try {
                await addDoc(guestbookColRef, { name, address, message, rsvp, timestamp: new Date() });
                guestbookForm.reset();
            } catch (err) { console.error("Error adding document: ", err); }
            finally { submitBtn.disabled = false; submitBtn.innerText = 'Kirim Ucapan'; }
        });

        function setupIntersectionObserver() {
             if (!animationEnabled) {
                document.querySelectorAll('.reveal').forEach(el => el.classList.add('visible'));
                return;
             }
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
        }

        function setupLightbox() {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            const lightboxClose = document.getElementById('lightbox-close');

            document.querySelectorAll('#gallery-grid img').forEach(img => {
                img.addEventListener('click', () => {
                    lightboxImg.src = img.src;
                    lightbox.classList.remove('hidden');
                    lightbox.classList.add('flex');
                });
            });

            lightboxClose.addEventListener('click', () => {
                lightbox.classList.add('hidden');
                lightbox.classList.remove('flex');
            });
             lightbox.addEventListener('click', (e) => {
                if(e.target === lightbox) {
                     lightbox.classList.add('hidden');
                     lightbox.classList.remove('flex');
                }
            });
        }

        const musicToggle = document.getElementById('music-toggle');
        const musicIcon = document.getElementById('music-icon');
        const audio = document.getElementById('background-music');
        
        musicToggle.addEventListener('click', () => {
            if (audio.paused) {
                audio.play().catch(e => console.error("Audio play failed:", e));
                musicIcon.classList.replace('fa-play', 'fa-pause');
            } else {
                audio.pause();
                musicIcon.classList.replace('fa-pause', 'fa-play');
            }
        });

    </script>
</body>
</html>
